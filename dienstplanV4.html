<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dienstplan-Ersteller</title>
    <!-- Tailwind CSS CDN für modernes Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styling für Kalendertage */
        .calendar-day:not(.is-not-current-month) {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .calendar-day:not(.is-not-current-month):hover {
            background-color: #e2e8f0; /* Leichtes Grau für Hover */
        }
        .calendar-day.is-selected {
            background-color: #a7f3d0; /* Helles Grün für ausgewählte Tage */
            color: #064e3b;
            font-weight: bold;
        }

        /* Styling für das Dialog-Modal */
        dialog::backdrop {
            background-color: rgba(17, 24, 39, 0.5); /* Dunkler, halbtransparenter Hintergrund */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Hauptcontainer der Anwendung -->
    <div class="bg-white rounded-3xl shadow-xl w-full max-w-6xl p-8 grid lg:grid-cols-2 gap-8">
        
        <!-- Kalender-Bereich -->
        <div>
            <div class="flex justify-between items-center mb-6">
                <button id="prevMonth" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    &lt;
                </button>
                <h2 id="currentMonthAndYear" class="text-2xl font-bold text-gray-800"></h2>
                <button id="nextMonth" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    &gt;
                </button>
            </div>
            
            <div class="grid grid-cols-7 text-center font-semibold text-gray-600 mb-2">
                <div class="p-2">Mo</div>
                <div class="p-2">Di</div>
                <div class="p-2">Mi</div>
                <div class="p-2">Do</div>
                <div class="p-2">Fr</div>
                <div class="p-2 text-red-500">Sa</div>
                <div class="p-2 text-red-500">So</div>
            </div>
            
            <div id="calendar" class="grid grid-cols-7 gap-1 text-center">
                <!-- Kalendertage werden hier von JavaScript eingefügt -->
            </div>
        </div>

        <!-- Termin-Liste und Download-Bereich -->
        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner flex flex-col h-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Deine Termine (<span id="totalEvents">0</span>)</h3>
            <ul id="eventList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <!-- Termin-Einträge werden hier von JavaScript eingefügt -->
            </ul>
            <div class="mt-6 pt-4 border-t border-gray-200">
                <button id="downloadIcs" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-colors duration-200">
                    Download .ics
                </button>
                <!-- Benachrichtigungsbox für den Download-Fehler -->
                <div id="messageBox" class="mt-2 hidden text-sm bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-xl" role="alert">
                    Es sind keine Termine zum Herunterladen vorhanden.
                </div>
            </div>
        </div>
        
    </div>

    <!-- Dialog-Modal für die Termin-Auswahl -->
    <dialog id="eventModal" class="p-8 w-full max-w-md rounded-3xl shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">Schicht für <span id="modalDate"></span></h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        
        <p class="text-gray-600 mb-4">Wähle eine Schicht:</p>
        <div class="grid grid-cols-3 gap-3 mb-6" id="shiftButtons">
            <button data-shift="RD1" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD1</button>
            <button data-shift="RD2" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD2</button>
            <button data-shift="RD3" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD3</button>
            <button data-shift="RD4" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD4</button>
            <button data-shift="RD5" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD5</button>
            <button data-shift="RDN1" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RDN1</button>
            <button data-shift="RDN2" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RDN2</button>
        </div>

        <p class="text-gray-600 mb-2">Oder Freitext:</p>
        <div class="flex gap-2">
            <input type="text" id="freeText" placeholder="Z.B. Urlaub, Fortbildung" class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow">
            <button id="saveFreeText" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Speichern</button>
        </div>
    </dialog>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM-Elemente abrufen
            const calendarEl = document.getElementById('calendar');
            const currentMonthAndYearEl = document.getElementById('currentMonthAndYear');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const eventModal = document.getElementById('eventModal'); // Jetzt ein <dialog>-Element
            const modalDateEl = document.getElementById('modalDate');
            const shiftButtonsEl = document.getElementById('shiftButtons');
            const freeTextEl = document.getElementById('freeText');
            const saveFreeTextBtn = document.getElementById('saveFreeText');
            const closeModalBtn = document.getElementById('closeModal');
            const eventListEl = document.getElementById('eventList');
            const totalEventsEl = document.getElementById('totalEvents');
            const downloadIcsBtn = document.getElementById('downloadIcs');
            const messageBox = document.getElementById('messageBox');

            // Zustand verwalten
            let currentDate = new Date();
            let selectedDate = null;
            let events = [];

            // Funktion zum Anzeigen einer temporären Meldung
            function showMessage(message) {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            }

            // Funktion zum Öffnen des Modals
            function openModal(date) {
                selectedDate = date;
                modalDateEl.textContent = new Date(selectedDate).toLocaleDateString('de-DE', { dateStyle: 'long' });
                eventModal.showModal(); // Verwendet die native showModal() Methode
            }

            // Funktion zum Schließen des Modals und Zurücksetzen des Zustands
            function closeModal() {
                eventModal.close(); // Verwendet die native close() Methode
                selectedDate = null;
                freeTextEl.value = '';
            }

            // Funktion zum Rendern des Kalenders
            function renderCalendar() {
                calendarEl.innerHTML = ''; // Kalender leeren
                
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                currentMonthAndYearEl.textContent = new Date(year, month).toLocaleString('de-DE', { month: 'long', year: 'numeric' });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const firstDayIndex = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; 
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const prevDaysInMonth = new Date(year, month, 0).getDate();

                // Leere Felder für den vorherigen Monat
                for (let i = 0; i < firstDayIndex; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day is-not-current-month text-gray-400 p-2 text-sm';
                    const prevDay = prevDaysInMonth - (firstDayIndex - i) + 1;
                    dayEl.textContent = prevDay;
                    calendarEl.appendChild(dayEl);
                }

                // Tage des aktuellen Monats
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    const dayFullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dayEl.className = `calendar-day p-4 rounded-lg text-sm transition-colors duration-100 flex flex-col items-center justify-center relative`;
                    dayEl.textContent = i;
                    
                    const existingEvent = events.find(e => e.date === dayFullDate);
                    if (existingEvent) {
                        dayEl.classList.add('is-selected');
                        const eventTextEl = document.createElement('div');
                        eventTextEl.textContent = existingEvent.shift;
                        eventTextEl.className = 'text-xs mt-1 text-emerald-800 font-bold absolute bottom-1 truncate w-full px-1';
                        dayEl.appendChild(eventTextEl);
                    }

                    dayEl.addEventListener('click', () => {
                        openModal(dayFullDate);
                    });
                    
                    calendarEl.appendChild(dayEl);
                }

                // Leere Felder für den nächsten Monat
                const totalCells = firstDayIndex + daysInMonth;
                const remainingCells = 42 - totalCells; 
                for (let i = 1; i <= remainingCells; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day is-not-current-month text-gray-400 p-2 text-sm';
                    dayEl.textContent = i;
                    calendarEl.appendChild(dayEl);
                }
            }

            // Funktion zum Aktualisieren der Event-Liste
            function updateEventList() {
                eventListEl.innerHTML = '';
                totalEventsEl.textContent = events.length;

                events.sort((a, b) => new Date(a.date) - new Date(b.date));

                events.forEach((event, index) => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-100 p-4 rounded-lg flex items-center justify-between shadow-sm';
                    
                    const eventText = document.createElement('span');
                    const formattedDate = new Date(event.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    eventText.textContent = `${formattedDate}: ${event.shift}`;
                    eventText.className = 'text-gray-700 font-medium';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold h-6 w-6 rounded-full flex items-center justify-center transition-colors';
                    deleteBtn.addEventListener('click', () => {
                        events.splice(index, 1);
                        updateEventList();
                        renderCalendar();
                    });

                    li.appendChild(eventText);
                    li.appendChild(deleteBtn);
                    eventListEl.appendChild(li);
                });
            }

            // Funktion zum Hinzufügen eines neuen Termins
            function addEvent(shift) {
                if (selectedDate) {
                    const existingEventIndex = events.findIndex(e => e.date === selectedDate);
                    if (existingEventIndex !== -1) {
                        events[existingEventIndex].shift = shift;
                    } else {
                        events.push({ date: selectedDate, shift: shift });
                    }
                    updateEventList();
                    renderCalendar();
                    closeModal();
                }
            }

            // Event-Listener für die Schicht-Buttons im Modal
            shiftButtonsEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('shift-btn')) {
                    addEvent(e.target.dataset.shift);
                }
            });

            // Event-Listener für den Freitext-Speichern-Button
            saveFreeTextBtn.addEventListener('click', () => {
                const freeTextValue = freeTextEl.value.trim();
                if (freeTextValue) {
                    addEvent(freeTextValue);
                }
            });

            // Event-Listener zum Schließen des Modals
            closeModalBtn.addEventListener('click', closeModal);

            // Event-Listener für Monat-Navigation
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // Funktion zum Generieren und Herunterladen der .ics-Datei
            downloadIcsBtn.addEventListener('click', () => {
                if (events.length === 0) {
                    showMessage('Es sind keine Termine zum Herunterladen vorhanden.');
                    return;
                }
                
                let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Dienstplan Ersteller//DE\n`;

                events.forEach(event => {
                    const date = new Date(event.date);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const nextDayDate = new Date(date);
                    nextDayDate.setDate(date.getDate() + 1);
                    const nextDayYear = nextDayDate.getFullYear();
                    const nextDayMonth = String(nextDayDate.getMonth() + 1).padStart(2, '0');
                    const nextDay = String(nextDayDate.getDate()).padStart(2, '0');
                    
                    icsContent += `BEGIN:VEVENT
UID:${event.date}-${event.shift}@dienstplan.creator
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART;VALUE=DATE:${year}${month}${day}
DTEND;VALUE=DATE:${nextDayYear}${nextDayMonth}${nextDay}
SUMMARY:${event.shift}
END:VEVENT\n`;
                });

                icsContent += `END:VCALENDAR`;

                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'dienstplan.ics';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });

            // Initialisierung
            renderCalendar();
            updateEventList();
        });
    </script>
</body>
</html>
