<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dienstplan-Ersteller</title>
    <!-- Tailwind CSS CDN für modernes Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styling für Kalendertage */
        .calendar-day:not(.is-not-current-month) {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .calendar-day:not(.is-not-current-month):hover {
            background-color: #e2e8f0; /* Leichtes Grau für Hover */
        }

        /* Styling für das Dialog-Modal */
        dialog::backdrop {
            background-color: rgba(17, 24, 39, 0.5); /* Dunkler, halbtransparenter Hintergrund */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Hauptcontainer der Anwendung -->
    <div class="bg-white rounded-3xl shadow-xl w-full max-w-6xl p-8 grid lg:grid-cols-2 gap-8">
        
        <!-- Kalender-Bereich -->
        <div>
            <div class="flex justify-between items-center mb-6">
                <button id="prevMonth" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    &lt;
                </button>
                <h2 id="currentMonthAndYear" class="text-2xl font-bold text-gray-800"></h2>
                <button id="nextMonth" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    &gt;
                </button>
            </div>
            
            <!-- Die Tagesabkürzungen mit dem neuen Styling -->
            <div class="grid grid-cols-7 text-center font-semibold text-white mb-2">
                <div class="p-2 bg-emerald-500 rounded-l-lg">Mo</div>
                <div class="p-2 bg-emerald-500">Di</div>
                <div class="p-2 bg-emerald-500">Mi</div>
                <div class="p-2 bg-emerald-500">Do</div>
                <div class="p-2 bg-emerald-500">Fr</div>
                <!-- Angepasste Farbe für Samstag -->
                <div class="p-2 bg-emerald-500 text-red-600">Sa</div>
                <!-- Angepasste Farbe für Sonntag -->
                <div class="p-2 bg-emerald-500 rounded-r-lg text-red-600">So</div>
            </div>
            
            <div id="calendar" class="grid grid-cols-7 gap-1 text-center">
                <!-- Kalendertage werden hier von JavaScript eingefügt -->
            </div>
        </div>

        <!-- Termin-Liste und Download-Bereich -->
        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner flex flex-col h-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Dienste (<span id="totalEvents">0</span>)</h3>
            <ul id="eventList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <!-- Termin-Einträge werden hier von JavaScript eingefügt -->
            </ul>
            <div class="mt-6 pt-4 border-t border-gray-200">
                <!-- Text von "Download .ics" zu "Download Dienstplan" geändert -->
                <button id="downloadIcs" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-colors duration-200">
                    Download Dienstplan
                </button>
                <!-- Benachrichtigungsbox für den Download-Fehler -->
                <div id="messageBox" class="mt-2 hidden text-sm bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-xl" role="alert">
                    Es sind keine Termine zum Herunterladen vorhanden.
                </div>
            </div>
        </div>
        
    </div>

    <!-- Dialog-Modal für die Termin-Auswahl -->
    <dialog id="eventModal" class="p-8 w-full max-w-md rounded-3xl shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">Schicht für <span id="modalDate"></span></h3>
            <!-- Aktualisierter Close Button mit SVG-Icon -->
            <button id="closeModal" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Ein Container für alle Modal-Inhalte, um einheitliche Abstände zu gewährleisten -->
        <div class="flex flex-col gap-4">
            <p class="text-gray-600">Wähle eine Schicht:</p>
            <div class="grid grid-cols-3 gap-3" id="dayShiftButtons">
                <button data-shift="RD1" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD1</button>
                <button data-shift="RD2" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD2</button>
                <button data-shift="RD3" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD3</button>
                <button data-shift="RD4" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD4</button>
                <button data-shift="RD5" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RD5</button>
            </div>
            
            <!-- Trennlinie ohne zusätzliche Margins, da der Abstand durch den Parent-Container geregelt wird -->
            <hr class="border-t-2 border-emerald-500">

            <div class="grid grid-cols-3 gap-3" id="nightShiftButtons">
                <button data-shift="RDN1" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RDN1</button>
                <button data-shift="RDN2" class="shift-btn bg-gray-200 hover:bg-emerald-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">RDN2</button>
            </div>

            <!-- Trennlinie vor dem Freitextfeld -->
            <hr class="border-t-2 border-emerald-500">

            <p class="text-gray-600">Oder Freitext:</p>
            <div class="flex gap-2">
                <input type="text" id="freeText" placeholder="Z.B. Urlaub, Fortbildung" class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow">
                <button id="saveFreeText" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Speichern</button>
            </div>
        </div>
    </dialog>
    
    <!-- Neues Pop-up für das Easter Egg -->
    <dialog id="easterEggModal" class="p-8 w-full max-w-md rounded-3xl shadow-2xl text-center">
        <div class="flex flex-col items-center gap-6">
            <!-- Lorbeerkranz SVG als Ersatz für den Tiroler Adler -->
            <svg class="h-24 w-24 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C8.134 2 5 5.134 5 9c0 2.455 1.258 4.646 3.197 5.927l-2.613 2.614c-.39.391-.39 1.024 0 1.415.391.39 1.024.39 1.415 0l2.614-2.613C9.354 17.742 11.545 19 14 19c3.866 0 7-3.134 7-7s-3.134-7-7-7zm0 14c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5zm5.727-8.106l-2.02-2.02c-.391-.391-1.024-.391-1.415 0-.39.39-.39 1.024 0 1.414l2.02 2.02c.39.39 1.024.39 1.414 0 .391-.39.391-1.024 0-1.414zM8.273 8.106c-.39-.39-.39-1.024 0-1.414s1.024-.39 1.414 0l2.02 2.02c.391.39 0 1.024-.39 1.414s-1.024 0-1.414-.39l-2.02-2.02z"/>
            </svg>
            <p class="text-gray-800 text-lg font-bold">Mit diesem Dienst trägst du die Bürde des Landes Tirol. Die Bevölkerung kann stolz auf dich sein</p>
            <button id="closeEasterEggModal" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-colors duration-200">
                Schließen
            </button>
        </div>
    </dialog>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM-Elemente abrufen
            const calendarEl = document.getElementById('calendar');
            const currentMonthAndYearEl = document.getElementById('currentMonthAndYear');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const eventModal = document.getElementById('eventModal');
            const modalDateEl = document.getElementById('modalDate');
            const dayShiftButtonsEl = document.getElementById('dayShiftButtons');
            const nightShiftButtonsEl = document.getElementById('nightShiftButtons');
            const freeTextEl = document.getElementById('freeText');
            const saveFreeTextBtn = document.getElementById('saveFreeText');
            const closeModalBtn = document.getElementById('closeModal');
            const eventListEl = document.getElementById('eventList');
            const totalEventsEl = document.getElementById('totalEvents');
            const downloadIcsBtn = document.getElementById('downloadIcs');
            const messageBox = document.getElementById('messageBox');
            
            // Neue DOM-Elemente für das Easter Egg Pop-up
            const easterEggModal = document.getElementById('easterEggModal');
            const closeEasterEggModalBtn = document.getElementById('closeEasterEggModal');

            // Zustand verwalten
            let currentDate = new Date();
            // Standardmäßig 2 Monate in der Zukunft anzeigen
            currentDate.setMonth(currentDate.getMonth() + 2);
            let selectedDate = null;
            let events = [];

            // Liste der vordefinierten Schichten
            const predefinedShifts = ["RD1", "RD2", "RD3", "RD4", "RD5", "RDN1", "RDN2"];

            // Funktion zum Anzeigen einer temporären Meldung
            function showMessage(message) {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            }

            // Funktion zum Öffnen des Modals
            function openModal(date) {
                selectedDate = date;
                modalDateEl.textContent = new Date(selectedDate).toLocaleDateString('de-DE', { dateStyle: 'long' });
                eventModal.showModal();
            }

            // Funktion zum Schließen des Modals und Zurücksetzen des Zustands
            function closeModal() {
                eventModal.close();
                selectedDate = null;
                freeTextEl.value = '';
            }

            // Funktion zum Schließen des Easter Egg Modals
            function closeEasterEggModal() {
                easterEggModal.close();
            }

            // Funktion zum Rendern des Kalenders
            function renderCalendar() {
                calendarEl.innerHTML = '';
                
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                currentMonthAndYearEl.textContent = new Date(year, month).toLocaleString('de-DE', { month: 'long', year: 'numeric' });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const firstDayIndex = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; 
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const prevDaysInMonth = new Date(year, month, 0).getDate();

                // Leere Felder für den vorherigen Monat
                for (let i = 0; i < firstDayIndex; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day is-not-current-month text-gray-400 p-2 text-sm';
                    const prevDay = prevDaysInMonth - (firstDayIndex - i) + 1;
                    dayEl.textContent = prevDay;
                    calendarEl.appendChild(dayEl);
                }

                // Tage des aktuellen Monats
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    const dayFullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const dayOfWeek = new Date(year, month, i).getDay(); // 0 = Sonntag, 6 = Samstag
                    
                    dayEl.className = `calendar-day p-4 rounded-lg text-sm transition-colors duration-100 flex flex-col items-center justify-center relative`;

                    // Überprüfen, ob es ein Wochenende ist und die entsprechende Klasse hinzufügen
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        dayEl.classList.add('bg-yellow-100'); // Leichter gelber Hintergrund
                    }

                    dayEl.textContent = i;
                    
                    const existingEvent = events.find(e => e.date === dayFullDate);
                    if (existingEvent) {
                        let bgColorClass, textColorClass;
                        // Logik zur Unterscheidung von Tagdienst, Nachtdienst und Freitext
                        if (existingEvent.type === 'predefined') {
                            if (existingEvent.shift.startsWith('RDN')) {
                                // Nachtdienst - Kräftiger Grünton
                                bgColorClass = 'bg-emerald-500';
                                textColorClass = 'text-white';
                            } else {
                                // Tagdienst - Heller Grünton (bg-emerald-400)
                                bgColorClass = 'bg-emerald-400';
                                textColorClass = 'text-white';
                            }
                        } else {
                            // Freitext-Eintrag
                            bgColorClass = 'bg-purple-200';
                            textColorClass = 'text-purple-800';
                        }
                        
                        dayEl.classList.add(bgColorClass);
                        
                        const eventTextEl = document.createElement('div');
                        eventTextEl.textContent = existingEvent.shift;

                        eventTextEl.className = `text-xs mt-1 ${textColorClass} font-bold absolute bottom-1 truncate w-full px-1`;
                        dayEl.appendChild(eventTextEl);
                    }

                    dayEl.addEventListener('click', () => {
                        openModal(dayFullDate);
                    });
                    
                    calendarEl.appendChild(dayEl);
                }

                // Leere Felder für den nächsten Monat
                const totalCells = firstDayIndex + daysInMonth;
                const remainingCells = 42 - totalCells; 
                for (let i = 1; i <= remainingCells; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day is-not-current-month text-gray-400 p-2 text-sm';
                    dayEl.textContent = i;
                    calendarEl.appendChild(dayEl);
                }
            }

            // Funktion zum Aktualisieren der Event-Liste
            function updateEventList() {
                eventListEl.innerHTML = '';
                totalEventsEl.textContent = events.length;

                events.sort((a, b) => new Date(a.date) - new Date(b.date));

                events.forEach((event, index) => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-100 p-4 rounded-lg flex items-center justify-between shadow-sm';
                    
                    const textContainer = document.createElement('div');
                    textContainer.className = 'flex items-center';
                    // Änderung: Monat wird jetzt ausgeschrieben
                    const formattedDate = new Date(event.date).toLocaleDateString('de-DE', { day: '2-digit', month: 'long' });
                    
                    // Bestimmen der CSS-Klasse basierend auf dem Event-Typ
                    const shiftClass = event.type === 'predefined' ? 'text-emerald-700' : 'text-purple-700';

                    // Änderung: Doppelpunkt durch Bindestrich mit Leerzeichen ersetzt
                    textContainer.innerHTML = `<span class="text-gray-700 font-medium">${formattedDate} - </span><span class="${shiftClass} font-bold">${event.shift}</span>`;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold h-6 w-6 rounded-full flex items-center justify-center transition-colors';
                    deleteBtn.addEventListener('click', () => {
                        events.splice(index, 1);
                        updateEventList();
                        renderCalendar();
                    });

                    li.appendChild(textContainer);
                    li.appendChild(deleteBtn);
                    eventListEl.appendChild(li);
                });
            }

            // Funktion zum Hinzufügen eines neuen Termins
            function addEvent(shift) {
                if (selectedDate) {
                    const eventType = predefinedShifts.includes(shift) ? 'predefined' : 'freeText';
                    const existingEventIndex = events.findIndex(e => e.date === selectedDate);
                    if (existingEventIndex !== -1) {
                        events[existingEventIndex].shift = shift;
                        events[existingEventIndex].type = eventType;
                    } else {
                        events.push({ date: selectedDate, shift: shift, type: eventType });
                    }
                    updateEventList();
                    renderCalendar();
                    closeModal();
                }
            }

            // Event-Listener für die Schicht-Buttons im Modal
            dayShiftButtonsEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('shift-btn')) {
                    addEvent(e.target.dataset.shift);
                }
            });
            nightShiftButtonsEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('shift-btn')) {
                    addEvent(e.target.dataset.shift);
                }
            });

            // Event-Listener für den Freitext-Speichern-Button
            saveFreeTextBtn.addEventListener('click', () => {
                const freeTextValue = freeTextEl.value.trim();
                // Überprüfen, ob das Easter Egg ausgelöst werden soll
                if (freeTextValue === "Sillian Lotse") {
                    closeModal();
                    easterEggModal.showModal();
                } else if (freeTextValue) {
                    addEvent(freeTextValue);
                }
            });

            // Event-Listener zum Schließen des Haupt-Modals
            closeModalBtn.addEventListener('click', closeModal);
            // Event-Listener zum Schließen des Easter Egg Modals
            closeEasterEggModalBtn.addEventListener('click', closeEasterEggModal);

            // Event-Listener für Monat-Navigation
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // Funktion zum Generieren und Herunterladen der .ics-Datei
            downloadIcsBtn.addEventListener('click', () => {
                if (events.length === 0) {
                    showMessage('Es sind keine Termine zum Herunterladen vorhanden.');
                    return;
                }
                
                // Monatsnamen des ersten Termins für den Dateinamen abrufen
                const firstEventDate = new Date(events[0].date);
                const monthName = firstEventDate.toLocaleString('de-DE', { month: 'long' });
                const filename = `dienstplan-${monthName.toLowerCase()}.ics`;

                let icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Dienstplan Ersteller//DE\n`;

                events.forEach(event => {
                    const date = new Date(event.date);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const nextDayDate = new Date(date);
                    nextDayDate.setDate(date.getDate() + 1);
                    const nextDayYear = nextDayDate.getFullYear();
                    const nextDayMonth = String(nextDayDate.getMonth() + 1).padStart(2, '0');
                    const nextDay = String(nextDayDate.getDate()).padStart(2, '0');
                    
                    icsContent += `BEGIN:VEVENT\nUID:${event.date}-${event.shift}@dienstplan.creator\nDTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\nDTSTART;VALUE=DATE:${year}${month}${day}\nDTEND;VALUE=DATE:${nextDayYear}${nextDayMonth}${nextDay}\nSUMMARY:${event.shift}\nEND:VEVENT\n`;
                });

                icsContent += `END:VCALENDAR`;

                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });

            // Initialisierung
            renderCalendar();
            updateEventList();
        });
    </script>
</body>
</html>
